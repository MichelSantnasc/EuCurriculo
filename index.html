<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EuCurrículo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>:root{--primary:#4f46e5;--primary-light:#eef2ff;--accent:#4338ca;}body{font-family:'Inter',sans-serif;background-color:#f9fafb;overflow-x:hidden;}@media (min-width: 1024px){.split-container{display:flex;flex-direction:row;height:100vh;overflow:hidden;}.form-side{flex:1;overflow-y:auto;padding:20px;}.preview-side{flex:1;background-color:#f3f4f6;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;overflow-y:auto;padding:40px 20px;border-left:1px solid #e5e7eb;}.a4-canvas{width:210mm;min-height:297mm;background:white;box-shadow:0 10px 30px rgba(0,0,0,0.1);padding:20mm 18mm;margin:0 auto;box-sizing:border-box;color:#1f2937;hyphens:auto;word-break:break-word;overflow-wrap:break-word;}}@media (max-width: 1023px){.split-container{flex-direction:column;}.preview-side{display:none;}#preview-modal{position:fixed;inset:0;background:rgba(0, 0, 0, 0.6);display:none;justify-content:center;align-items:flex-start;z-index:1000;padding-top:8px;}#preview-modal-content{background:white;width:96%;max-width:420px;max-height:96vh;border-radius:16px;overflow:hidden;position:relative;box-shadow:0 10px 30px rgba(0,0,0,0.3);}#close-modal{position:absolute;top:12px;right:16px;background:rgba(255,255,255,0.95);border:none;font-size:28px;font-weight:bold;color:#333;cursor:pointer;z-index:10;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;}#modal-capture-area{width:100%;max-height:calc(96vh - 60px);overflow-y:auto;padding:12px 10px;box-sizing:border-box;background:#f9fafb;}.a4-canvas{width:100% !important;max-width:100%;min-height:auto !important;padding:14mm 12mm !important;margin:0 auto;transform:none;box-shadow:0 4px 15px rgba(0,0,0,0.15);font-size:0.95rem;line-height:1.45;hyphens:auto;word-break:break-word;overflow-wrap:break-word;}.a4-canvas *{max-width:100% !important;word-break:break-word;overflow-wrap:break-word;hyphens:auto;}}.step-content{display:none;}.step-content.active{display:block;animation:fadeIn 0.4s ease;}@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}.progress-fixed{position:sticky;top:0;z-index:50;background:rgba(255, 255, 255, 0.95);backdrop-filter:blur(8px);}.form-input{transition:all 0.3s ease;border:1px solid #d1d5db;border-radius:0.75rem;padding:0.75rem;}.form-input:focus{border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-light);}.filled{border-color:#22c55e !important;background-color:#f0fdf4 !important;}.tpl-moderno{font-family:'Inter',sans-serif;}.tpl-moderno .header{border-bottom:4px solid var(--primary);padding-bottom:16px;}.tpl-classico{font-family:'Georgia',serif;line-height:1.6;}.tpl-classico .header{text-align:center;border-bottom:2px solid #111827;margin-bottom:24px;}.tpl-criativo{font-family:'Inter',sans-serif;background:linear-gradient(to bottom, #f3f4f6, white);}.tpl-criativo .header{background:var(--primary);color:white;padding:16px;border-radius:8px;}#loading-overlay{position:fixed;inset:0;background:rgba(255,255,255,0.8);display:none;z-index:1000;place-items:center;} body.overflow-hidden {overflow: hidden;height: 100vh;}</style>
</head>
<body class="text-gray-800">
    <div id="loading-overlay" class="grid">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
            <p class="font-bold text-indigo-800">Processando Currículo...</p>
        </div>
    </div>

    <div class="split-container">
        <div class="form-side bg-white">
            <header class="p-4 md:p-6 border-b flex flex-col md:flex-row justify-between items-center gap-4">
                <h1 class="text-2xl font-bold text-indigo-600 flex items-center gap-2">
                    <i class="fas fa-file-invoice"></i> EuCurrículo
                </h1>
                <button id="preview-btn-mobile" class="lg:hidden bg-indigo-600 text-white px-4 py-2 rounded-lg text-xs font-bold transition flex items-center gap-2">
                    <i class="fas fa-eye"></i> Ver Preview
                </button>
            </header>

            <div class="progress-fixed border-b px-4 md:px-6 py-4">
                <div class="flex justify-between items-center mb-2">
                    <span id="step-label" class="text-xs font-bold uppercase tracking-wider text-indigo-700">Dados Pessoais</span>
                    <span id="progress-percent" class="text-xs font-bold text-indigo-700">25%</span>
                </div>
                <div class="w-full bg-gray-100 rounded-full h-2">
                    <div id="progress-bar" class="bg-indigo-600 h-2 rounded-full transition-all duration-500" style="width: 25%"></div>
                </div>
            </div>

            <div class="form-container max-w-4xl mx-auto">
                <form id="cv-form" oninput="handleFormInput()">
                    <section id="step1" class="step-content active space-y-6">
                        <div class="flex flex-col md:flex-row items-start gap-6">
                            <div id="photo-container" class="w-32 h-32 bg-gray-50 border-2 border-dashed border-gray-200 rounded-xl flex items-center justify-center relative overflow-hidden group">
                                <i class="fas fa-user text-gray-300 text-4xl group-hover:scale-110 transition"></i>
                                <img id="img-preview" class="hidden absolute inset-0 w-full h-full object-cover" alt="Foto de perfil">
                                <button type="button" onclick="removePhoto()" id="btn-remove-photo" class="hidden absolute top-1 right-1 bg-red-500 text-white w-6 h-6 rounded-full text-[10px]"><i class="fas fa-times"></i></button>
                            </div>
                            <div class="flex-1 space-y-2">
                                <h2 class="text-lg font-bold text-gray-800">Foto de Perfil</h2>
                                <p class="text-sm text-gray-500">Formatos: JPG, PNG. Tamanho máx: 2MB</p>
                                <input type="file" id="photo-input" accept="image/*" class="hidden" onchange="handlePhoto(event)">
                                <button type="button" onclick="document.getElementById('photo-input').click()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md">Upload Foto</button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nome Completo *</label>
                                <input type="text" name="nome" placeholder="João Exemplo Silva" class="form-input w-full" required>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">E-mail *</label>
                                <input type="email" name="email" placeholder="contato@email.com" class="form-input w-full" required>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nacionalidade</label>
                                <select name="nacionalidade" class="form-input w-full bg-white">
                                    <option value="">Selecione...</option>
                                    <option>Brasileira</option>
                                    <option>Estrangeira</option>
                                    <option>Outra</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Estado Civil</label>
                                <select name="estado_civil" class="form-input w-full bg-white">
                                    <option value="">Selecione...</option>
                                    <option>Solteiro(a)</option>
                                    <option>Casado(a)</option>
                                    <option>Divorciado(a)</option>
                                    <option>Viúvo(a)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Idade</label>
                                <input type="number" name="idade" placeholder="Ex: 28" class="form-input w-full">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">PCD (Pessoa com Deficiência)</label>
                                <select name="pcd" class="form-input w-full bg-white" onchange="togglePcdDetails(this)">
                                    <option value="">Selecione...</option>
                                    <option value="nao">Não</option>
                                    <option value="sim">Sim</option>
                                </select>
                            </div>
                            <div id="pcd-details" class="md:col-span-2 hidden">
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Detalhes PCD (opcional)</label>
                                <textarea name="pcd_detalhes" rows="2" placeholder="Descreva a deficiência..." class="form-input w-full"></textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">CEP</label>
                                <input type="text" name="cep" id="cep" placeholder="00000-000" onblur="fetchCEP(this.value)" class="form-input w-full">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Endereço (opcional)</label>
                                <input type="text" name="endereco" placeholder="Rua, número, bairro" class="form-input w-full">
                            </div>
                            <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="md:col-span-2">
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Cidade</label>
                                    <input type="text" name="cidade" id="cidade" class="form-input w-full">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">UF</label>
                                    <input type="text" name="uf" id="uf" maxlength="2" class="form-input w-full text-center uppercase">
                                </div>
                            </div>
                        </div>

                        <div id="tel-list" class="space-y-4">
                            <label class="block text-xs font-bold text-gray-500 uppercase">Telefones para Contato</label>
                            <div class="tel-item space-y-2 md:flex md:space-y-0 md:gap-2 md:items-center">
                                <input type="text" name="telefone[]" oninput="maskPhone(this)" placeholder="(00) 00000-0000" class="form-input flex-1" required>
                                <div class="flex items-center gap-1 bg-gray-50 px-3 py-3 rounded-xl border">
                                    <input type="checkbox" name="is_whatsapp[]" class="w-4 h-4 accent-indigo-600">
                                    <span class="text-[10px] font-bold text-gray-500">WHATSAPP</span>
                                </div>
                                <button type="button" onclick="removeThis(this)" class="btn-del text-red-400 hover:text-red-600 hidden"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <button type="button" onclick="addTel()" class="text-indigo-600 text-xs font-bold flex items-center gap-1 hover:underline">
                            <i class="fas fa-plus-circle"></i> Adicionar Outro Telefone
                        </button>
                    </section>

                    <section id="step2" class="step-content space-y-6">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Objetivo Profissional *</label>
                            <textarea name="objetivo" rows="4" placeholder="Ex: Atuar na área de vendas buscando crescimento..." class="form-input w-full" required></textarea>
                        </div>

                        <div class="flex items-center gap-2 bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                            <input type="checkbox" id="no-exp" onchange="toggleExperience(this)" class="w-5 h-5 accent-indigo-600 cursor-pointer">
                            <label for="no-exp" class="text-sm font-bold text-indigo-800 cursor-pointer">Não possuo experiência / Primeiro Emprego</label>
                        </div>

                        <div id="exp-list" class="space-y-6">
                            <div class="exp-item p-4 md:p-6 border rounded-xl bg-white relative space-y-4">
                                <h4 class="text-indigo-600 font-bold text-xs uppercase">Experiência Profissional</h4>
                                <input type="text" name="exp_cargo[]" placeholder="Cargo (Ex: Vendedor)" class="form-input w-full">
                                <input type="text" name="exp_empresa[]" placeholder="Empresa" class="form-input w-full">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <input type="number" name="exp_inicio[]" placeholder="Ano Início" class="form-input w-full">
                                    <div class="relative">
                                        <input type="number" name="exp_fim[]" placeholder="Ano Fim" class="form-input w-full">
                                        <label class="absolute -bottom-5 right-0 text-[10px] flex items-center gap-1 font-bold text-gray-500">
                                            <input type="checkbox" name="exp_atual[]" onchange="toggleAtual(this)"> ATUAL
                                        </label>
                                    </div>
                                </div>
                                <textarea name="exp_desc[]" rows="2" placeholder="Descreva brevemente suas atividades..." class="form-input w-full"></textarea>
                                <button type="button" onclick="removeThis(this)" class="btn-del absolute top-4 right-4 text-red-400 hover:text-red-600 hidden"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <button type="button" id="btn-add-exp" onclick="addExp()" class="text-indigo-600 text-xs font-bold flex items-center gap-1 hover:underline">
                            <i class="fas fa-plus-circle"></i> Adicionar Nova Experiência
                        </button>
                    </section>

                    <section id="step3" class="step-content space-y-6">
                        <div id="edu-list" class="space-y-6">
                            <div class="edu-item p-4 md:p-6 border rounded-xl bg-white relative space-y-4">
                                <h4 class="text-indigo-600 font-bold text-xs uppercase">Formação Acadêmica</h4>
                                <select name="edu_nivel[]" class="form-input w-full bg-white">
                                    <option value="">Selecione o Nível...</option>
                                    <option>Sem instrução / Analfabeto</option>
                                    <option>Ensino Fundamental Incompleto</option>
                                    <option>Ensino Fundamental Completo</option>
                                    <option>Ensino Médio Incompleto</option>
                                    <option>Ensino Médio Completo</option>
                                    <option>Técnico Incompleto</option>
                                    <option>Técnico Completo</option>
                                    <option>Superior Incompleto – Bacharelado</option>
                                    <option>Superior Completo – Bacharelado</option>
                                    <option>Superior Incompleto – Licenciatura</option>
                                    <option>Superior Completo – Licenciatura</option>
                                    <option>Superior Incompleto – Tecnólogo</option>
                                    <option>Superior Completo – Tecnólogo</option>
                                    <option>Especialização / Pós-graduação Lato Sensu</option>
                                    <option>Mestrado Incompleto</option>
                                    <option>Mestrado Completo</option>
                                    <option>Doutorado Incompleto</option>
                                    <option>Doutorado Completo</option>
                                    <option>Pós-doutorado</option>
                                </select>
                                <input type="text" name="edu_inst[]" placeholder="Instituição (Ex: USP, Escola Estadual...)" class="form-input w-full">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <input type="number" name="edu_inicio[]" placeholder="Ano Início (opcional)" class="form-input w-full">
                                    <input type="number" name="edu_fim[]" placeholder="Ano Término (opcional)" class="form-input w-full">
                                </div>
                                <button type="button" onclick="removeThis(this)" class="btn-del absolute top-4 right-4 text-red-400 hover:text-red-600 hidden"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <button type="button" onclick="addEdu()" class="text-indigo-600 text-xs font-bold flex items-center gap-1 hover:underline">
                            <i class="fas fa-plus-circle"></i> Adicionar Formação
                        </button>

                        <div class="border-t pt-6">
                            <h3 class="font-bold text-gray-800 mb-4">Idiomas</h3>
                            <div id="lang-list" class="space-y-4">
                                <div class="lang-item space-y-2 md:flex md:space-y-0 md:gap-2 md:items-center">
                                    <select name="lang_nome[]" class="form-input flex-1 bg-white">
                                        <option value="">Idioma...</option>
                                        <option>Inglês</option>
                                        <option>Espanhol</option>
                                        <option>Francês</option>
                                        <option>Chinês (Mandarim)</option>
                                        <option>Árabe</option>
                                        <option>Hindi</option>
                                        <option>Português</option>
                                        <option>Russo</option>
                                        <option>Japonês</option>
                                        <option>Alemão</option>
                                        <option>Coreano</option>
                                        <option>Italiano</option>
                                    </select>
                                    <select name="lang_nivel[]" class="form-input flex-1 bg-white">
                                        <option value="">Nível...</option>
                                        <option>Básico</option>
                                        <option>Intermediário</option>
                                        <option>Avançado</option>
                                        <option>Fluente</option>
                                        <option>Nativo</option>
                                    </select>
                                    <button type="button" onclick="removeThis(this)" class="btn-del text-red-400 hover:text-red-600 hidden"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            <button type="button" onclick="addLang()" class="mt-3 text-indigo-600 text-xs font-bold flex items-center gap-1 hover:underline">
                                <i class="fas fa-plus-circle"></i> Adicionar Idioma
                            </button>
                        </div>
                    </section>

                    <section id="step4" class="step-content space-y-6">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Habilidades Técnicas e Interpessoais *</label>
                            <textarea name="habilidades" rows="5" placeholder="Ex: Comunicação assertiva, Pacote Office avançado, Gestão de equipes..." class="form-input w-full" required></textarea>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Detalhes Adicionais (Opcional)</label>
                            <textarea name="adicionais" rows="3" placeholder="Ex: Disponibilidade para viagens, CNH B, Projetos voluntários..." class="form-input w-full"></textarea>
                        </div>

                        <div class="bg-indigo-50 border border-indigo-100 p-6 rounded-xl">
                            <h3 class="font-bold text-indigo-800 mb-2">Tudo pronto?</h3>
                            <p class="text-xs text-indigo-600 mb-6">Confira o preview antes de baixar.</p>
                            <button type="button" id="btn-gerar" onclick="downloadCV()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-xl transition flex items-center justify-center gap-3">
                                <i class="fas fa-cloud-download-alt"></i> BAIXAR CURRÍCULO (PDF)
                            </button>
                            <p id="validation-msg" class="text-[10px] text-red-500 mt-2 font-bold hidden text-center">Preencha todos os campos obrigatórios</p>
                        </div>
                    </section>

                    <div class="flex justify-between items-center mt-12 pt-6 border-t">
                        <button type="button" id="btn-prev" onclick="moveStep(-1)" class="px-4 py-2 rounded-xl border border-gray-300 font-bold text-gray-500 hover:bg-gray-50 invisible">Anterior</button>
                        <button type="button" id="btn-next" onclick="moveStep(1)" class="px-6 py-2 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 transition">Seguinte</button>
                    </div>
                </form>
            </div>

            <footer class="p-6 border-t bg-gray-50 mt-8">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4 text-center md:text-left">
                    <p class="text-xs text-gray-500">© 2024 EuCurrículo - Feito por <a href="https://www.instagram.com/michelsantnasc/" target="_blank" class="text-indigo-600 font-bold hover:underline">Santnasc</a></p>
                    <button 
                     onclick="window.open('https:linktr.ee/santnasc')" 
                     class="bg-yellow-100 text-yellow-700 px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-2 hover:bg-yellow-200 transition">
                    <i class="fas fa-coffee"></i> Me pague um café
                    </button>
                </div>
            </footer>
        </div>

        <div class="preview-side">
            <div class="mb-6 flex flex-col md:flex-row gap-4 bg-white p-4 rounded-xl shadow-sm justify-between w-full max-w-2xl mx-auto">
                <div class="flex gap-4">
                    <button onclick="changeTemplate('moderno')" class="tpl-btn active px-4 py-2 rounded-xl text-xs font-bold border transition" id="btn-tpl-moderno">Moderno</button>
                    <button onclick="changeTemplate('classico')" class="tpl-btn px-4 py-2 rounded-xl text-xs font-bold border transition" id="btn-tpl-classico">Clássico</button>
                    <button onclick="changeTemplate('criativo')" class="tpl-btn px-4 py-2 rounded-xl text-xs font-bold border transition" id="btn-tpl-criativo">Criativo</button>
                </div>
                <button onclick="downloadCV()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2 mt-4 md:mt-0">
                    <i class="fas fa-cloud-download-alt"></i> Baixar PDF
                </button>
            </div>

            <div id="capture-area" class="w-full">
                <div id="resume-render" class="a4-canvas tpl-moderno overflow-hidden">
                    <div class="h-full flex flex-col items-center justify-center text-gray-300">
                        <i class="fas fa-file-invoice text-6xl mb-4"></i>
                        <p class="font-bold">Aguardando dados...</p>
                    </div>
                </div>
            </div>

            <div class="mt-6 text-gray-500 text-xs flex items-center gap-2">
                <i class="fas fa-info-circle"></i>
                Pré-visualização em tempo real (A4)
            </div>
        </div>
    </div>

    <div id="preview-modal" class="hidden">
        <div id="preview-modal-content">
            <button id="close-modal">&times;</button>
            <div class="mb-4 flex flex-col gap-4 bg-white p-2 rounded-xl shadow-sm w-full">
                <div class="flex gap-4 flex-wrap justify-center">
                    <button onclick="changeTemplate('moderno')" class="tpl-btn active px-3 py-1 rounded-lg text-xs font-bold border transition" id="btn-tpl-moderno-mobile">Moderno</button>
                    <button onclick="changeTemplate('classico')" class="tpl-btn px-3 py-1 rounded-lg text-xs font-bold border transition" id="btn-tpl-classico-mobile">Clássico</button>
                    <button onclick="changeTemplate('criativo')" class="tpl-btn px-3 py-1 rounded-lg text-xs font-bold border transition" id="btn-tpl-criativo-mobile">Criativo</button>
                </div>
                <button onclick="downloadCV()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-xs font-bold transition flex items-center gap-2 justify-center">
                    <i class="fas fa-cloud-download-alt"></i> Baixar PDF
                </button>
            </div>
            <div id="modal-capture-area">
                <div id="resume-render-modal" class="a4-canvas tpl-moderno"></div>
            </div>
        </div>
    </div>

<script>
    let currentStep = 1;
    let selectedTemplate = 'moderno';
    let userPhoto = '';

    function moveStep(delta) {
        if (delta > 0 && !validateStep(currentStep)) return;
        
        currentStep += delta;
        if (currentStep < 1) currentStep = 1;
        if (currentStep > 4) currentStep = 4;

        document.querySelectorAll('.step-content').forEach((s, i) => {
            s.classList.toggle('active', (i + 1) === currentStep);
        });

        document.getElementById('btn-prev').classList.toggle('invisible', currentStep === 1);
        document.getElementById('btn-next').style.display = currentStep === 4 ? 'none' : 'block';
        
        const progress = (currentStep / 4) * 100;
        document.getElementById('progress-bar').style.width = `${progress}%`;
        document.getElementById('progress-percent').innerText = `${Math.round(progress)}%`;

        const stepLabels = ["Dados Pessoais", "Objetivo & Experiência", "Formação & Idiomas", "Habilidades & Adicionais"];
        document.getElementById('step-label').innerText = stepLabels[currentStep - 1];
        
        document.querySelector('.form-side').scrollTo({ top: 0, behavior: 'smooth' });
    }

    function validateStep(step) {
        const currentSec = document.getElementById(`step${step}`);
        const requireds = currentSec.querySelectorAll('[required]');
        let valid = true;

        requireds.forEach(input => {
            if (!input.value.trim()) {
                input.classList.add('border-red-500');
                valid = false;
            } else {
                input.classList.remove('border-red-500');
            }
        });
        return valid;
    }

    function handleFormInput() {
        document.querySelectorAll('.form-input').forEach(input => {
            let isFilled = input.value && input.value.trim() !== '';
            if (input.tagName === 'SELECT') isFilled = input.selectedIndex > 0;
            if (input.type === 'checkbox') isFilled = input.checked;

            input.classList.toggle('filled', isFilled);
        });

        renderResume();
    }

    async function fetchCEP(val) {
        const cep = val.replace(/\D/g, '');
        if (cep.length !== 8) return;

        try {
            const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            const data = await res.json();
            if (!data.erro) {
                document.getElementById('cidade').value = data.localidade;
                document.getElementById('uf').value = data.uf.toUpperCase();
                handleFormInput();
            }
        } catch (e) {}
    }

    function handlePhoto(e) {
        const file = e.target.files[0];
        if (!file || file.size > 2 * 1024 * 1024) {
            alert('Arquivo inválido ou muito grande (máx 2MB)');
            return;
        }

        const reader = new FileReader();
        reader.onload = (ev) => {
            userPhoto = ev.target.result;
            document.getElementById('img-preview').src = userPhoto;
            document.getElementById('img-preview').classList.remove('hidden');
            document.getElementById('btn-remove-photo').classList.remove('hidden');
            renderResume();
        };
        reader.readAsDataURL(file);
    }

    function removePhoto() {
        userPhoto = '';
        document.getElementById('img-preview').classList.add('hidden');
        document.getElementById('btn-remove-photo').classList.add('hidden');
        document.getElementById('photo-input').value = '';
        renderResume();
    }

function maskPhone(input) {
    let v = input.value.replace(/\D/g, ''); // remove tudo que não é número

    // Limita a 11 dígitos (DDD + 9 dígitos)
    if (v.length > 11) v = v.substring(0, 11);

    // Formatação dinâmica
    if (v.length <= 2) {
        input.value = v;
    } else if (v.length <= 6) {
        input.value = `(${v.substring(0,2)}) ${v.substring(2)}`;
    } else if (v.length <= 10) {
        input.value = `(${v.substring(0,2)}) ${v.substring(2,6)}-${v.substring(6)}`;
    } else {
        // Celular com 9 dígitos
        input.value = `(${v.substring(0,2)}) ${v.substring(2,7)}-${v.substring(7)}`;
    }
}

    function togglePcdDetails(select) {
        document.getElementById('pcd-details').classList.toggle('hidden', select.value !== 'sim');
        renderResume();
    }

    function addTel() {
        const container = document.getElementById('tel-list');
        const div = document.createElement('div');
        div.className = 'tel-item space-y-2 md:flex md:space-y-0 md:gap-2 md:items-center';
        div.innerHTML = `
            <input type="text" name="telefone[]" oninput="maskPhone(this)" placeholder="(00) 00000-0000" class="form-input flex-1">
            <div class="flex items-center gap-1 bg-gray-50 px-3 py-3 rounded-xl border">
                <input type="checkbox" name="is_whatsapp[]" class="w-4 h-4 accent-indigo-600">
                <span class="text-[10px] font-bold text-gray-500">WHATSAPP</span>
            </div>
            <button type="button" onclick="removeThis(this)" class="btn-del text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>`;
        container.appendChild(div);
        checkRemoveButtons('tel-item');
    }

    function addExp() {
        const container = document.getElementById('exp-list');
        const div = document.createElement('div');
        div.className = 'exp-item p-4 md:p-6 border rounded-xl bg-white relative space-y-4';
        div.innerHTML = `
            <h4 class="text-indigo-600 font-bold text-xs uppercase">Experiência Profissional</h4>
            <input type="text" name="exp_cargo[]" placeholder="Cargo" class="form-input w-full">
            <input type="text" name="exp_empresa[]" placeholder="Empresa" class="form-input w-full">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="number" name="exp_inicio[]" placeholder="Início" class="form-input w-full">
                <div class="relative">
                    <input type="number" name="exp_fim[]" placeholder="Fim" class="form-input w-full">
                    <label class="absolute -bottom-5 right-0 text-[10px] flex items-center gap-1 font-bold text-gray-500">
                        <input type="checkbox" name="exp_atual[]" onchange="toggleAtual(this)"> ATUAL
                    </label>
                </div>
            </div>
            <textarea name="exp_desc[]" rows="2" placeholder="Descrição..." class="form-input w-full"></textarea>
            <button type="button" onclick="removeThis(this)" class="btn-del absolute top-4 right-4 text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>`;
        container.appendChild(div);
        checkRemoveButtons('exp-item');
    }

    function addEdu() {
        const container = document.getElementById('edu-list');
        const div = document.createElement('div');
        div.className = 'edu-item p-4 md:p-6 border rounded-xl bg-white relative space-y-4';
        div.innerHTML = `
            <h4 class="text-indigo-600 font-bold text-xs uppercase">Formação Acadêmica</h4>
            <select name="edu_nivel[]" class="form-input w-full bg-white">
                <option value="">Selecione o Nível...</option>
                <option>Sem instrução / Analfabeto</option>
                <option>Ensino Fundamental Incompleto</option>
                <option>Ensino Fundamental Completo</option>
                <option>Ensino Médio Incompleto</option>
                <option>Ensino Médio Completo</option>
                <option>Técnico Incompleto</option>
                <option>Técnico Completo</option>
                <option>Superior Incompleto – Bacharelado</option>
                <option>Superior Completo – Bacharelado</option>
                <option>Superior Incompleto – Licenciatura</option>
                <option>Superior Completo – Licenciatura</option>
                <option>Superior Incompleto – Tecnólogo</option>
                <option>Superior Completo – Tecnólogo</option>
                <option>Especialização / Pós-graduação Lato Sensu</option>
                <option>Mestrado Incompleto</option>
                <option>Mestrado Completo</option>
                <option>Doutorado Incompleto</option>
                <option>Doutorado Completo</option>
                <option>Pós-doutorado</option>
            </select>
            <input type="text" name="edu_inst[]" placeholder="Instituição" class="form-input w-full">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="number" name="edu_inicio[]" placeholder="Início" class="form-input w-full">
                <input type="number" name="edu_fim[]" placeholder="Término" class="form-input w-full">
            </div>
            <button type="button" onclick="removeThis(this)" class="btn-del absolute top-4 right-4 text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>`;
        container.appendChild(div);
        checkRemoveButtons('edu-item');
    }

    function addLang() {
        const container = document.getElementById('lang-list');
        const div = document.createElement('div');
        div.className = 'lang-item space-y-2 md:flex md:space-y-0 md:gap-2 md:items-center';
        div.innerHTML = `
            <select name="lang_nome[]" class="form-input flex-1 bg-white">
                <option value="">Idioma...</option>
                <option>Inglês</option>
                <option>Espanhol</option>
                <option>Francês</option>
                <option>Chinês (Mandarim)</option>
                <option>Árabe</option>
                <option>Hindi</option>
                <option>Português</option>
                <option>Russo</option>
                <option>Japonês</option>
                <option>Alemão</option>
                <option>Coreano</option>
                <option>Italiano</option>
            </select>
            <select name="lang_nivel[]" class="form-input flex-1 bg-white">
                <option value="">Nível...</option>
                <option>Básico</option>
                <option>Intermediário</option>
                <option>Avançado</option>
                <option>Fluente</option>
                <option>Nativo</option>
            </select>
            <button type="button" onclick="removeThis(this)" class="btn-del text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>`;
        container.appendChild(div);
        checkRemoveButtons('lang-item');
    }

    function removeThis(btn) {
        btn.parentElement.remove();
        checkRemoveButtons(btn.parentElement.className.split(' ')[0]);
        renderResume();
    }

    function checkRemoveButtons(cls) {
        document.querySelectorAll(`.${cls}`).forEach(item => {
            const btn = item.querySelector('.btn-del');
            if (btn) btn.style.display = document.querySelectorAll(`.${cls}`).length > 1 ? 'block' : 'none';
        });
    }

    function toggleExperience(cb) {
        const list = document.getElementById('exp-list');
        const btn = document.getElementById('btn-add-exp');
        list.style.opacity = cb.checked ? '0.3' : '1';
        list.style.pointerEvents = cb.checked ? 'none' : 'auto';
        btn.classList.toggle('hidden', cb.checked);
        renderResume();
    }

    function toggleAtual(cb) {
        const input = cb.parentElement.previousElementSibling;
        input.disabled = cb.checked;
        if (cb.checked) input.value = "";
        renderResume();
    }

    function changeTemplate(tpl) {
        selectedTemplate = tpl;
        document.querySelectorAll('.tpl-btn').forEach(b => b.classList.remove('active', 'border-indigo-500', 'text-indigo-600', 'bg-indigo-50'));
        document.getElementById(`btn-tpl-${tpl}`)?.classList.add('active', 'border-indigo-500', 'text-indigo-600', 'bg-indigo-50');
        document.getElementById(`btn-tpl-${tpl}-mobile`)?.classList.add('active', 'border-indigo-500', 'text-indigo-600', 'bg-indigo-50');
        
        document.getElementById('resume-render').className = `a4-canvas tpl-${tpl}`;
        document.getElementById('resume-render-modal').className = `a4-canvas tpl-${tpl}`;
        renderResume();
    }

    function renderResume() {
        const form = document.getElementById('cv-form');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        const target = document.getElementById('resume-render');
        const targetModal = document.getElementById('resume-render-modal');

        const getListData = (selector, fields) => {
            return Array.from(document.querySelectorAll(selector)).map(item => {
                const obj = {};
                fields.forEach(f => {
                    const el = item.querySelector(`[name="${f}"]`);
                    if (el) obj[f.replace('[]', '')] = el.type === 'checkbox' ? el.checked : el.value;
                });
                return obj;
            });
        };

        const tels = getListData('.tel-item', ['telefone[]', 'is_whatsapp[]']);
        const exps = getListData('.exp-item', ['exp_cargo[]', 'exp_empresa[]', 'exp_inicio[]', 'exp_fim[]', 'exp_atual[]', 'exp_desc[]']);
        const edus = getListData('.edu-item', ['edu_nivel[]', 'edu_inst[]', 'edu_inicio[]', 'edu_fim[]']);
        const langs = getListData('.lang-item', ['lang_nome[]', 'lang_nivel[]']);

        if (!data.nome && !data.objetivo && !userPhoto) {
            const placeholder = `<div class="h-full flex flex-col items-center justify-center text-gray-300"><i class="fas fa-file-invoice text-6xl mb-4"></i><p class="font-bold">Aguardando dados...</p></div>`;
            target.innerHTML = targetModal.innerHTML = placeholder;
            return;
        }

        let html = `
            <div class="header mb-8">
                <div class="flex flex-col md:flex-row justify-between items-start gap-6">
                    <div class="flex-1">
                        <h1 class="text-3xl md:text-4xl font-bold uppercase text-gray-900 break-words hyphens-auto">${data.nome || 'NOME COMPLETO'}</h1>
                        <div class="text-sm text-gray-600 mt-3 space-y-1.5">
                            ${data.email ? `<div><i class="fas fa-envelope text-indigo-600 mr-2"></i>${data.email}</div>` : ''}
                            ${tels.filter(t => t.telefone).map(t => `<div><i class="fas fa-phone text-indigo-600 mr-2"></i>${t.telefone}${t.is_whatsapp ? ' <i class="fab fa-whatsapp text-green-500"></i>' : ''}</div>`).join('')}
                            ${data.endereco ? `<div><i class="fas fa-home text-indigo-600 mr-2"></i>${data.endereco}</div>` : ''}
                            ${data.cidade ? `<div><i class="fas fa-map-marker-alt text-indigo-600 mr-2"></i>${data.cidade}, ${data.uf}</div>` : ''}
                        </div>
                        <div class="text-sm text-gray-500 mt-2 flex flex-wrap gap-2">
                            ${data.nacionalidade ? `<span>Nacionalidade: ${data.nacionalidade}</span>` : ''}
                            ${data.estado_civil ? `<span>Estado Civil: ${data.estado_civil}</span>` : ''}
                            ${data.idade ? `<span>Idade: ${data.idade} anos</span>` : ''}
                            ${data.pcd === 'sim' ? `<span>PCD: Sim${data.pcd_detalhes ? ` (${data.pcd_detalhes})` : ''}</span>` : ''}
                        </div>
                    </div>
                    ${userPhoto ? `<img src="${userPhoto}" class="w-32 h-32 md:w-40 md:h-40 rounded-full object-cover border-4 border-indigo-100 shadow-lg flex-shrink-0">` : ''}
                </div>
            </div>

            <div class="section mb-8">
                <h2 class="text-lg font-bold text-indigo-700 uppercase border-b border-gray-200 pb-2 mb-3">Objetivo Profissional</h2>
                <p class="text-sm text-gray-700 leading-relaxed break-words hyphens-auto">${data.objetivo || '...'}</p>
            </div>
        `;

        if (!document.getElementById('no-exp').checked) {
            const activeExps = exps.filter(e => e.exp_cargo);
            if (activeExps.length > 0) {
                html += `<div class="section mb-8">
                    <h2 class="text-lg font-bold text-indigo-700 uppercase border-b border-gray-200 pb-2 mb-3">Experiência Profissional</h2>
                    ${activeExps.map(e => `
                        <div class="mb-6">
                            <div class="flex justify-between items-baseline">
                                <h3 class="text-base font-bold text-gray-800">${e.exp_cargo}</h3>
                                <span class="text-sm text-gray-500 whitespace-nowrap ml-4">${e.exp_inicio} — ${e.exp_atual ? 'Atual' : e.exp_fim}</span>
                            </div>
                            <div class="text-sm text-indigo-600 italic">${e.exp_empresa}</div>
                            <p class="text-sm text-gray-600 mt-2 leading-relaxed break-words hyphens-auto">${e.exp_desc ? e.exp_desc.replace(/\n/g, '<br>') : ''}</p>
                        </div>
                    `).join('')}
                </div>`;
            }
        } else {
            html += `<div class="section mb-8">
                <h2 class="text-lg font-bold text-indigo-700 uppercase border-b border-gray-200 pb-2 mb-3">Experiência</h2>
                <p class="text-sm italic text-gray-500">Em busca da primeira oportunidade profissional.</p>
            </div>`;
        }

        const activeEdus = edus.filter(e => e.edu_nivel);
        if (activeEdus.length > 0) {
            html += `<div class="section mb-8">
                <h2 class="text-lg font-bold text-indigo-700 uppercase border-b border-gray-200 pb-2 mb-3">Formação Acadêmica</h2>
                ${activeEdus.map(e => `
                    <div class="mb-4">
                        <div class="flex justify-between items-baseline">
                            <h3 class="text-base font-bold text-gray-800">${e.edu_nivel}</h3>
                            <span class="text-sm text-gray-500 whitespace-nowrap ml-4">${e.edu_inicio} — ${e.edu_fim || ''}</span>
                        </div>
                        <div class="text-sm text-gray-600">${e.edu_inst}</div>
                    </div>
                `).join('')}
            </div>`;
        }

        const activeLangs = langs.filter(l => l.lang_nome);
        if (activeLangs.length > 0 || data.habilidades) {
            html += `<div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                ${data.habilidades ? `
                    <div>
                        <h2 class="text-lg font-bold text-indigo-700 uppercase border-b border-gray-200 pb-2 mb-3">Habilidades</h2>
                        <p class="text-sm text-gray-600 leading-relaxed break-words hyphens-auto whitespace-pre-wrap">${data.habilidades}</p>
                    </div>
                ` : ''}
                ${activeLangs.length > 0 ? `
                    <div>
                        <h2 class="text-lg font-bold text-indigo-700 uppercase border-b border-gray-200 pb-2 mb-3">Idiomas</h2>
                        <div class="text-sm text-gray-600 space-y-2">
                            ${activeLangs.map(l => `<div><strong>${l.lang_nome}:</strong> ${l.lang_nivel}</div>`).join('')}
                        </div>
                    </div>
                ` : ''}
            </div>`;
        }

        if (data.adicionais) {
            html += `<div class="section">
                <h2 class="text-lg font-bold text-indigo-700 uppercase border-b border-gray-200 pb-2 mb-3">Informações Adicionais</h2>
                <p class="text-sm text-gray-600 leading-relaxed break-words hyphens-auto">${data.adicionais.replace(/\n/g, '<br>')}</p>
            </div>`;
        }

        target.innerHTML = targetModal.innerHTML = html;
    }

    function downloadCV() {
        const nome = document.querySelector('[name="nome"]').value?.trim();
        const objetivo = document.querySelector('[name="objetivo"]').value?.trim();
        const habilidades = document.querySelector('[name="habilidades"]').value?.trim();
        const hasTel = [...document.querySelectorAll('[name="telefone[]"]')].some(t => t.value.trim());
        const hasEdu = [...document.querySelectorAll('[name="edu_nivel[]"]')].some(e => e.value);

        if (!nome || !objetivo || !habilidades || !hasTel || !hasEdu) {
            document.getElementById('validation-msg').classList.remove('hidden');
            setTimeout(() => document.getElementById('validation-msg').classList.add('hidden'), 4000);
            return;
        }

        const btn = document.getElementById('btn-gerar');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner animate-spin"></i> Gerando PDF...';

        const element = document.getElementById('resume-render');
        html2pdf()
            .from(element)
            .set({
                margin: 0,
                filename: `Curriculo_${nome.replace(/\s+/g, '_')}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            })
            .save()
            .then(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-cloud-download-alt"></i> BAIXAR CURRÍCULO (PDF)';
            });
    }

// Modal Mobile - Versão corrigida e robusta
document.addEventListener('DOMContentLoaded', () => {
    const previewBtnMobile = document.getElementById('preview-btn-mobile');
    const previewModal = document.getElementById('preview-modal');
    const closeModalBtn = document.getElementById('close-modal');

    if (!previewBtnMobile || !previewModal) {
        console.warn('Elementos do modal mobile não encontrados');
        return;
    }

    // Abre o modal
    previewBtnMobile.addEventListener('click', () => {
        renderResume(); // atualiza o conteúdo antes
        previewModal.classList.remove('hidden');
        previewModal.style.display = 'flex'; // fallback forte
        document.body.classList.add('overflow-hidden');
    });

    // Fecha com botão X
    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', () => {
            previewModal.classList.add('hidden');
            previewModal.style.display = 'none';
            document.body.classList.remove('overflow-hidden');
        });
    }

    // Fecha clicando fora do conteúdo
    previewModal.addEventListener('click', (e) => {
        if (e.target === previewModal) {
            previewModal.classList.add('hidden');
            previewModal.style.display = 'none';
            document.body.classList.remove('overflow-hidden');
        }
    });
});

    // Inicialização
    checkRemoveButtons('tel-item');
    checkRemoveButtons('exp-item');
    checkRemoveButtons('edu-item');
    checkRemoveButtons('lang-item');
</script>
</body>
</html>
